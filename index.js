import "dotenv/config";
import {
  Client,
  GatewayIntentBits,
  REST,
  Routes,
  PermissionFlagsBits,
  EmbedBuilder,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
} from "discord.js";
import fetch from "node-fetch";

const discordBot = new Client({
  intents: [
    GatewayIntentBits.Guilds, 
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.GuildPresences
  ],
});

const SERVER_URL = process.env.SERVER_URL;
const GUILD_ID = process.env.GUILD_ID;
const CLIENT_ID = process.env.CLIENT_ID;

// ============================================================
// üìú Patentes e Cargos Correspondentes
// ============================================================
const rankGroups = {
  Civis: ["N/A"],
  Pra√ßas: ["[REC]", "[SLD]"],
  Graduados: ["[CB]", "[T-SGT]", "[S-SGT]", "[P-SGT]", "[S-BTN]"],
  Oficiais: ["[AAO]", "[STN]", "[PTN]", "[CAP]", "[MAJ]", "[TEN-C]", "[COR]"],
  Generais: ["[GEN-B]", "[GEN-D]", "[GEN-E]", "[S-COM]", "[COM]"],
};

const patents = {
  1: "N/A",
  2: "[REC] Recruta",
  3: "[SLD] Soldado",
  4: "[CB] Cabo",
  5: "[T-SGT] Terceiro-Sargento",
  6: "[S-SGT] Segundo-Sargento",
  7: "[P-SGT] Primeiro-Sargento",
  8: "[S-BTN] Sub-Tenente",
  9: "[AAO] Aspirante-√Å-Oficial",
  10: "[STN] Segundo-Tenente",
  11: "[PTN] Primeiro-Tenente",
  12: "[CAP] Capit√£o",
  13: "[MAJ] Major",
  14: "[TEN-C] Tenente-Coronel",
  15: "[COR] Coronel",
  16: "[GEN-B] General-De-Brigada",
  17: "[GEN-D] General-De-Divis√£o",
  18: "[GEN-E] General-De-Ex√©rcito",
  19: "[S-COM] Sub-Comandante",
  20: "[COM] Comandante",
};

// ============================================================
// üóÉÔ∏è Armazenamento de usernames do Roblox
// ============================================================
const robloxUsernames = new Map(); // Map<discordId, robloxUsername>

// ============================================================
// üé® Cores para os Embeds
// ============================================================
const embedColors = {
  SUCCESS: 0x2ecc71,    // Verde
  ERROR: 0xe74c3c,      // Vermelho
  WARNING: 0xf39c12,    // Laranja
  INFO: 0x3498db,       // Azul
  MILITARY: 0x2c3e50,   // Azul militar
  PROMOTION: 0x9b59b6,  // Roxo para promo√ß√µes
  WELCOME: 0x1abc9c,    // Verde √°gua para boas-vindas
  VERIFIED: 0x00ff00,   // Verde para verifica√ß√£o
};

// ============================================================
// üí¨ Registrar Comandos
// ============================================================
const commands = [
  {
    name: "conectar",
    description: "üéñÔ∏è Verifica sua conta Roblox usando um c√≥digo gerado no jogo",
    options: [
      {
        name: "codigo",
        type: 3,
        description: "üî¢ C√≥digo gerado no Roblox",
        required: true,
      },
    ],
  },
  {
    name: "atualizar",
    description: "‚ö° Atualiza a patente e nick de um usu√°rio (Apenas Administradores)",
    default_member_permissions: PermissionFlagsBits.Administrator.toString(),
    options: [
      {
        name: "usuario",
        type: 6, // USER
        description: "üéØ Usu√°rio que ser√° atualizado",
        required: true,
      },
      {
        name: "patente",
        type: 4, // INTEGER
        description: "üéñÔ∏è N√∫mero da patente (1-20)",
        required: true,
        choices: [
          { name: "üü° Civil (N/A)", value: 1 },
          { name: "üü¢ [REC] Recruta", value: 2 },
          { name: "üü¢ [SLD] Soldado", value: 3 },
          { name: "üîµ [CB] Cabo", value: 4 },
          { name: "üîµ [T-SGT] Terceiro-Sargento", value: 5 },
          { name: "üîµ [S-SGT] Segundo-Sargento", value: 6 },
          { name: "üîµ [P-SGT] Primeiro-Sargento", value: 7 },
          { name: "üîµ [S-BTN] Sub-Tenente", value: 8 },
          { name: "üî¥ [AAO] Aspirante-√Å-Oficial", value: 9 },
          { name: "üî¥ [STN] Segundo-Tenente", value: 10 },
          { name: "üî¥ [PTN] Primeiro-Tenente", value: 11 },
          { name: "üî¥ [CAP] Capit√£o", value: 12 },
          { name: "üî¥ [MAJ] Major", value: 13 },
          { name: "üî¥ [TEN-C] Tenente-Coronel", value: 14 },
          { name: "üî¥ [COR] Coronel", value: 15 },
          { name: "üü£ [GEN-B] General-De-Brigada", value: 16 },
          { name: "üü£ [GEN-D] General-De-Divis√£o", value: 17 },
          { name: "üü£ [GEN-E] General-De-Ex√©rcito", value: 18 },
          { name: "üü£ [S-COM] Sub-Comandante", value: 19 },
          { name: "üü£ [COM] Comandante", value: 20 },
        ],
      },
    ],
  },
  {
    name: "patentes",
    description: "üìä Lista todas as patentes dispon√≠veis no sistema",
  },
  {
    name: "manual",
    description: "üìö Manual de instru√ß√µes para verifica√ß√£o de conta",
  },
];

const rest = new REST({ version: "10" }).setToken(process.env.DISCORD_TOKEN);

(async () => {
  try {
    console.log("üì¶ Registrando comandos...");
    await rest.put(
      Routes.applicationGuildCommands(CLIENT_ID, GUILD_ID),
      { body: commands }
    );
    console.log("‚úÖ Comandos registrados com sucesso!");
  } catch (err) {
    console.error("Erro ao registrar comandos:", err);
  }
})();

// ============================================================
// üöÄ Inicializa o bot
// ============================================================
discordBot.once("ready", () => {
  console.log(`ü§ñ Bot do Discord logado como ${discordBot.user.tag}`);
  
  // Definir status do bot
  discordBot.user.setActivity("Comandos Militares | /manual", { type: "WATCHING" });
});

// ============================================================
// üéØ EVENTO: Intera√ß√µes de Bot√µes
// ============================================================
discordBot.on("interactionCreate", async (interaction) => {
  // Se for um comando de chat, j√° tratamos em outro lugar
  if (interaction.isChatInputCommand()) return;
  
  // Se for uma intera√ß√£o de bot√£o
  if (interaction.isButton()) {
    await interaction.deferReply({ ephemeral: true });
    
    const buttonId = interaction.customId;
    
    switch (buttonId) {
      case 'manual_instructions':
        const manualEmbed = createMilitaryEmbed(
          "üìö MANUAL DE INSTRU√á√ïES",
          "**Guia completo para verifica√ß√£o de conta militar**\n\nSiga os passos abaixo para se integrar √†s for√ßas armadas:"
        );

        manualEmbed.addFields(
          {
            name: "üéÆ PASSO 1: Obter C√≥digo no Roblox",
            value: "‚Ä¢ Entre no jogo Roblox\n‚Ä¢ V√° at√© o **Quartel General**\n‚Ä¢ Use o comando `/gerarcodigo`\n‚Ä¢ Anote o c√≥digo de 6 d√≠gitos",
            inline: false
          },
          {
            name: "üíª PASSO 2: Verificar no Discord",
            value: "‚Ä¢ Use o comando `/conectar <c√≥digo>`\n‚Ä¢ Substitua `<c√≥digo>` pelo c√≥digo obtido\n‚Ä¢ Aguarde a verifica√ß√£o autom√°tica",
            inline: false
          },
          {
            name: "‚úÖ PASSO 3: Confirma√ß√£o",
            value: "‚Ä¢ Seu nickname ser√° atualizado\n‚Ä¢ Voc√™ receber√° o cargo **Membro Verificado**\n‚Ä¢ Patente militar atribu√≠da automaticamente\n‚Ä¢ **Username do Roblox salvo para promo√ß√µes futuras**\n‚Ä¢ Verifica√ß√£o conclu√≠da com sucesso!",
            inline: false
          },
          {
            name: "üéñÔ∏è PROMO√á√ïES FUTURAS",
            value: "‚Ä¢ Use `/atualizar` (apenas administradores)\n‚Ä¢ Pr√©-requisito: Cargo 'Membro Verificado'\n‚Ä¢ **Usar√° o username do Roblox salvo**\n‚Ä¢ Hierarquia completa dispon√≠vel em `/patentes`",
            inline: false
          },
          {
            name: "üö® SUPORTE",
            value: "‚Ä¢ Problemas? Contate um **Oficial**\n‚Ä¢ C√≥digo n√£o funciona? Gere outro\n‚Ä¢ Erro persistente? Reporte ao comando",
            inline: false
          }
        );

        await interaction.editReply({ 
          embeds: [manualEmbed],
          ephemeral: true 
        });
        break;

      case 'verify_account':
        const verifyEmbed = createMilitaryEmbed(
          "üéÆ VERIFICA√á√ÉO DE CONTA",
          "**Para verificar sua conta Roblox:**\n\n" +
          "1. **Entre no jogo Roblox** e v√° at√© o Quartel General\n" +
          "2. **Use o comando** `/gerarcodigo` no chat do jogo\n" +
          "3. **Anote o c√≥digo** de 6 d√≠gitos que aparecer\n" +
          "4. **Volte para o Discord** e use o comando:\n" +
          "```/conectar codigo: SEU_CODIGO_AQUI```\n\n" +
          "üìû **Precisa de ajuda?** Contate um oficial!",
          embedColors.INFO
        );

        await interaction.editReply({ 
          embeds: [verifyEmbed],
          ephemeral: true 
        });
        break;

      case 'suporte':
        const supportEmbed = createMilitaryEmbed(
          "üìû SUPORTE T√âCNICO",
          "**Precisa de ajuda?**\n\n" +
          "üîπ **Problemas com verifica√ß√£o?**\n" +
          "‚Ä¢ Verifique se digitou o c√≥digo corretamente\n" +
          "‚Ä¢ O c√≥digo expira ap√≥s alguns minutos\n" +
          "‚Ä¢ Gere um novo c√≥digo se necess√°rio\n\n" +
          "üîπ **Contate a equipe:**\n" +
          "‚Ä¢ Procure por cargos de **Oficial** ou **Administrador**\n" +
          "‚Ä¢ Abra um ticket no canal apropriado\n" +
          "‚Ä¢ Descreva detalhadamente o problema\n\n" +
          "üéØ **Solu√ß√µes comuns:**\n" +
          "‚Ä¢ Use `/manual` para ver instru√ß√µes detalhadas\n" +
          "‚Ä¢ Certifique-se de estar no servidor correto do Roblox\n" +
          "‚Ä¢ Verifique suas permiss√µes no Discord",
          embedColors.WARNING
        );

        await interaction.editReply({ 
          embeds: [supportEmbed],
          ephemeral: true 
        });
        break;

      default:
        const unknownEmbed = createMilitaryEmbed(
          "‚ùå BOT√ÉO DESCONHECIDO",
          "Este bot√£o n√£o est√° configurado corretamente.\n\nContate um administrador para resolver o problema.",
          embedColors.ERROR
        );
        await interaction.editReply({ 
          embeds: [unknownEmbed],
          ephemeral: true 
        });
        break;
    }
  }
});

// ============================================================
// üéØ Fun√ß√£o para criar embed militar
// ============================================================
function createMilitaryEmbed(title, description, color = embedColors.MILITARY, fields = [], thumbnail = null) {
  const embed = new EmbedBuilder()
    .setTitle(`üéñÔ∏è ${title}`)
    .setDescription(description)
    .setColor(color)
    .setTimestamp()
    .setFooter({ 
      text: 'Sistema Militar de Verifica√ß√£o', 
      iconURL: 'https://i.imgur.com/8S3j3Zy.png' 
    });

  if (fields.length > 0) {
    embed.addFields(...fields);
  }

  if (thumbnail) {
    embed.setThumbnail(thumbnail);
  }

  return embed;
}

// ============================================================
// üîß Fun√ß√£o para atribuir cargo Civis automaticamente
// ============================================================
async function assignCivilRole(member) {
  try {
    const guild = member.guild;
    const civilRole = guild.roles.cache.find(r => r.name === "Civis");
    
    if (!civilRole) {
      console.warn("‚ùå Cargo 'Civis' n√£o encontrado no servidor!");
      return false;
    }

    // Verificar se o membro j√° tem o cargo Civis
    if (member.roles.cache.has(civilRole.id)) {
      return true;
    }

    // Atribuir o cargo Civis
    await member.roles.add(civilRole);
    console.log(`‚úÖ Cargo Civis atribu√≠do automaticamente para: ${member.user.tag}`);
    
    return true;
  } catch (error) {
    console.error("‚ùå Erro ao atribuir cargo Civis:", error);
    return false;
  }
}

// ============================================================
// ‚úÖ Fun√ß√£o para atribuir cargo Membro Verificado
// ============================================================
async function assignVerifiedRole(member) {
  try {
    const guild = member.guild;
    const verifiedRole = guild.roles.cache.find(r => 
      r.name === "Membro Verificado" || r.name === "Verificado"
    );
    
    if (!verifiedRole) {
      console.warn("‚ùå Cargo 'Membro Verificado' n√£o encontrado no servidor!");
      return false;
    }

    // Verificar se o membro j√° tem o cargo
    if (member.roles.cache.has(verifiedRole.id)) {
      return true;
    }

    // Atribuir o cargo Membro Verificado
    await member.roles.add(verifiedRole);
    console.log(`‚úÖ Cargo Membro Verificado atribu√≠do para: ${member.user.tag}`);
    
    return true;
  } catch (error) {
    console.error("‚ùå Erro ao atribuir cargo Membro Verificado:", error);
    return false;
  }
}

// ============================================================
// üîß Fun√ß√£o para verificar se usu√°rio √© verificado
// ============================================================
function isUserVerified(member) {
  const verifiedRole = member.roles.cache.find(r => 
    r.name === "Membro Verificado" || r.name === "Verificado"
  );
  return !!verifiedRole;
}

// ============================================================
// üîß Fun√ß√£o para obter username do Roblox
// ============================================================
function getRobloxUsername(discordId) {
  return robloxUsernames.get(discordId) || null;
}

// ============================================================
// üîß Fun√ß√£o para atualizar nickname e cargo (CORRIGIDA)
// ============================================================
async function updateNicknameAndRole(member, shortTag, robloxUsername = null) {
  try {
    const isCivil = shortTag === "N/A" || !shortTag;
    
    // üîç Tentar obter o username do Roblox se n√£o foi fornecido
    const actualRobloxUsername = robloxUsername || getRobloxUsername(member.id);
    
    if (isCivil) {
      // Se for Civil: limpar qualquer tag militar e manter apenas o username do Discord
      const cleanNickname = member.user.username;
      const finalNickname = cleanNickname.length > 32 ? cleanNickname.substring(0, 32) : cleanNickname;
      await member.setNickname(finalNickname);
    } else {
      // Se for Militar: usar a tag militar + username do Roblox (se dispon√≠vel) ou username do Discord
      const displayUsername = actualRobloxUsername || member.user.username;
      const newNickname = `${shortTag} ${displayUsername}`;
      const finalNickname = newNickname.length > 32 ? newNickname.substring(0, 32) : newNickname;
      await member.setNickname(finalNickname);
    }

    // Gerenciar cargos militares
    const roleNames = Object.keys(rankGroups);
    const rolesToRemove = member.roles.cache.filter((r) =>
      roleNames.includes(r.name)
    );
    await member.roles.remove(rolesToRemove);

    let newRoleName = "Civis";
    for (const [group, tags] of Object.entries(rankGroups)) {
      if (tags.includes(shortTag)) {
        newRoleName = group;
        break;
      }
    }

    const guild = member.guild;
    const newRole = guild.roles.cache.find((r) => r.name === newRoleName);
    if (newRole) await member.roles.add(newRole);

    console.log(`‚úÖ Atualizado: ${member.user.tag} ‚Üí ${member.nickname || member.user.username} (${newRoleName})`);
    return { 
      newRoleName, 
      finalNickname: member.nickname || member.user.username,
      robloxUsername: actualRobloxUsername 
    };
  } catch (err) {
    console.warn("Erro ao atualizar nickname/role:", err.message);
    throw err;
  }
}

// ============================================================
// üëã EVENTO: Quando um membro entra no servidor
// ============================================================
discordBot.on("guildMemberAdd", async (member) => {
  console.log(`üÜï Novo membro entrou: ${member.user.tag}`);
  
  // Atribuir cargo Civis automaticamente
  const success = await assignCivilRole(member);
  
  // Canal de boas-vindas (opcional)
  const welcomeChannel = member.guild.channels.cache.find(
    channel => channel.name.toLowerCase().includes("boas-vindas") || 
               channel.name.toLowerCase().includes("welcome") ||
               channel.name.toLowerCase().includes("entrada")
  );

  if (welcomeChannel) {
    try {
      const welcomeEmbed = createMilitaryEmbed(
        "üéâ NOVO RECRUTA CHEGOU!",
        `**Bem-vindo √†s For√ßas Armadas, ${member.user}!**\n\n` +
        `üìç **Identifica√ß√£o:** ${member.user.tag}\n` +
        `üéñÔ∏è **Cargo Inicial:** Civis\n` +
        `üìÖ **Data de Alistamento:** <t:${Math.floor(Date.now() / 1000)}:F>\n\n` +
        `**üìù Pr√≥ximos Passos:**\n` +
        `‚Ä¢ Use \`/manual\` para ver as instru√ß√µes\n` +
        `‚Ä¢ Use \`/conectar\` para verificar sua conta Roblox\n` +
        `‚Ä¢ Obede√ßa √†s ordens dos superiores!`,
        embedColors.WELCOME,
        [],
        member.user.displayAvatarURL()
      );

      const welcomeRow = new ActionRowBuilder()
        .addComponents(
          new ButtonBuilder()
            .setLabel('üìö Manual de Instru√ß√µes')
            .setStyle(ButtonStyle.Primary)
            .setCustomId('manual_instructions'),
          new ButtonBuilder()
            .setLabel('üéÆ Verificar Conta')
            .setStyle(ButtonStyle.Success)
            .setCustomId('verify_account')
        );

      await welcomeChannel.send({ 
        content: `üéâ ${member.user} acaba de se alistar!`,
        embeds: [welcomeEmbed],
        components: [welcomeRow]
      });
    } catch (error) {
      console.error("‚ùå Erro ao enviar mensagem de boas-vindas:", error);
    }
  }

  // Canal de logs
  const logChannel = member.guild.channels.cache.find(
    c => c.name.toLowerCase() === "logs"
  );
  
  if (logChannel && success) {
    const logEmbed = createMilitaryEmbed(
      "üìã NOVO ALISTAMENTO",
      `**Novo recruta chegou ao servidor:**\n\n` +
      `**Usu√°rio:** ${member.user.tag}\n` +
      `**ID:** ${member.user.id}\n` +
      `**Cargo Atribu√≠do:** Civis\n` +
      `**Data:** <t:${Math.floor(Date.now() / 1000)}:F>`,
      embedColors.INFO
    );
    
    await logChannel.send({ embeds: [logEmbed] });
  }
});

// ============================================================
// üß† Intera√ß√µes (Comandos)
// ============================================================
discordBot.on("interactionCreate", async (interaction) => {
  if (!interaction.isChatInputCommand()) return;
  const { commandName } = interaction;

  // ========================================================
  // /conectar
  // ========================================================
  if (commandName === "conectar") {
    const code = interaction.options.getString("codigo");
    await interaction.deferReply({ ephemeral: true });

    try {
      const loadingEmbed = createMilitaryEmbed(
        "VERIFICA√á√ÉO EM ANDAMENTO",
        "üîç **Processando sua verifica√ß√£o...**\n\n‚è≥ Aguarde enquanto validamos suas credenciais.",
        embedColors.INFO
      );
      await interaction.editReply({ embeds: [loadingEmbed] });

      const response = await fetch(`${SERVER_URL}/api/check-code`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code,
          discordId: interaction.user.id,
        }),
      });

      const data = await response.json();
      if (!response.ok) {
        const errorEmbed = createMilitaryEmbed(
          "FALHA NA VERIFICA√á√ÉO",
          `‚ùå **Erro durante a verifica√ß√£o:**\n\`${data.error || "Erro desconhecido"}\`\n\nüìû Caso o problema persista, contate o comando.`,
          embedColors.ERROR
        );
        return interaction.editReply({ embeds: [errorEmbed] });
      }

      const guild = await discordBot.guilds.fetch(GUILD_ID);
      const member = await guild.members.fetch(interaction.user.id);

      let shortTag;
      if (data.shortTag) {
        shortTag = data.shortTag;
      } else if (data.patent) {
        shortTag = data.patent.split(" ")[0];
      } else {
        shortTag = "";
      }

      const username = data.username;
      
      // üíæ SALVAR USERNAME DO ROBLOX PARA USO FUTURO
      if (username) {
        robloxUsernames.set(interaction.user.id, username);
        console.log(`üíæ Username do Roblox salvo: ${interaction.user.id} ‚Üí ${username}`);
      }

      const { newRoleName, finalNickname, robloxUsername } = await updateNicknameAndRole(member, shortTag, username);

      // ‚úÖ Atribuir cargo Membro Verificado ap√≥s verifica√ß√£o bem-sucedida
      const verifiedAssigned = await assignVerifiedRole(member);

      const successEmbed = createMilitaryEmbed(
        "VERIFICA√á√ÉO CONCLU√çDA",
        `‚úÖ **Verifica√ß√£o militar conclu√≠da com sucesso!**\n\nüéØ Suas credenciais foram validadas e seu perfil foi atualizado.`,
        embedColors.SUCCESS,
        [
          { name: "üîπ Identifica√ß√£o", value: `\`${finalNickname}\``, inline: true },
          { name: "üîπ Patente", value: `\`${shortTag}\``, inline: true },
          { name: "üîπ Cargo", value: `\`${newRoleName}\``, inline: true },
          { name: "üéÆ Roblox", value: `\`${robloxUsername || username}\``, inline: true },
          { name: "‚úÖ Status", value: verifiedAssigned ? "`Verificado`" : "`Pendente`", inline: true },
          { name: "üîπ Data", value: `<t:${Math.floor(Date.now() / 1000)}:F>`, inline: false },
        ],
        member.user.displayAvatarURL()
      );

      // Canal de logs
      const logChannel = guild.channels.cache.find(
        (c) => c.name.toLowerCase() === "logs"
      );
      if (logChannel) {
        const logEmbed = createMilitaryEmbed(
          "NOVA VERIFICA√á√ÉO",
          `**Soldado verificado:** ${member.user.tag}\n**Identifica√ß√£o:** ${finalNickname}\n**Roblox:** ${robloxUsername || username}\n**Cargo:** ${newRoleName}\n**Status:** ${verifiedAssigned ? "Verificado" : "Pendente"}`,
          embedColors.VERIFIED
        );
        logChannel.send({ embeds: [logEmbed] });
      }

      return interaction.editReply({ embeds: [successEmbed] });
    } catch (err) {
      console.error("Erro ao verificar:", err);
      const errorEmbed = createMilitaryEmbed(
        "ERRO INTERNO",
        "‚ùå **Ocorreu um erro interno durante a verifica√ß√£o.**\n\nüìû Contate o comando imediatamente.",
        embedColors.ERROR
      );
      return interaction.editReply({ embeds: [errorEmbed] });
    }
  }

  // ========================================================
  // /atualizar
  // ========================================================
  if (commandName === "atualizar") {
    if (!interaction.member.permissions.has(PermissionFlagsBits.Administrator)) {
      const deniedEmbed = createMilitaryEmbed(
        "ACESSO NEGADO",
        "üö´ **Permiss√£o insuficiente!**\n\nApenas oficiais autorizados podem executar este comando.",
        embedColors.ERROR
      );
      return interaction.reply({ embeds: [deniedEmbed], ephemeral: true });
    }

    const target = interaction.options.getUser("usuario");
    const patenteNumber = interaction.options.getInteger("patente");
    const newTagFull = patents[patenteNumber];

    if (!newTagFull) {
      const errorEmbed = createMilitaryEmbed(
        "PATENTE INV√ÅLIDA",
        "‚ùå **N√∫mero de patente inv√°lido!**\n\nUse `/patentes` para ver a lista completa.",
        embedColors.ERROR
      );
      return interaction.reply({ embeds: [errorEmbed], ephemeral: true });
    }

    await interaction.deferReply({ ephemeral: true });

    try {
      const newTag = newTagFull.split(" ")[0];
      const guild = await discordBot.guilds.fetch(GUILD_ID);
      const member = await guild.members.fetch(target.id);

      // ‚úÖ VERIFICAR SE O USU√ÅRIO √â MEMBRO VERIFICADO
      if (!isUserVerified(member)) {
        const notVerifiedEmbed = createMilitaryEmbed(
          "USU√ÅRIO N√ÉO VERIFICADO",
          `‚ùå **O usu√°rio ${target.tag} n√£o est√° verificado!**\n\n` +
          `üìã **Pr√©-requisito necess√°rio:**\n` +
          `‚Ä¢ O usu√°rio deve usar \`/conectar\` primeiro\n` +
          `‚Ä¢ Deve ter o cargo "Membro Verificado"\n` +
          `‚Ä¢ Apenas usu√°rios verificados podem receber patentes militares`,
          embedColors.ERROR
        );
        return interaction.editReply({ embeds: [notVerifiedEmbed] });
      }

      // üîç OBTER USERNAME DO ROBLOX SALVO
      const robloxUsername = getRobloxUsername(target.id);
      
      if (!robloxUsername) {
        const noUsernameEmbed = createMilitaryEmbed(
          "USERNAME N√ÉO ENCONTRADO",
          `‚ùå **N√£o foi poss√≠vel encontrar o username do Roblox para ${target.tag}!**\n\n` +
          `üìã **Solu√ß√£o:**\n` +
          `‚Ä¢ O usu√°rio deve usar \`/conectar\` novamente\n` +
          `‚Ä¢ Isso ir√° registrar o username do Roblox corretamente\n` +
          `‚Ä¢ Ou contate um desenvolvedor do sistema`,
          embedColors.ERROR
        );
        return interaction.editReply({ embeds: [noUsernameEmbed] });
      }

      const { newRoleName, finalNickname } = await updateNicknameAndRole(member, newTag, robloxUsername);

      const successEmbed = createMilitaryEmbed(
        "ATUALIZA√á√ÉO CONCLU√çDA",
        `‚ö° **Atualiza√ß√£o militar realizada com sucesso!**\n\nO perfil do soldado foi atualizado conforme ordens superiores.`,
        embedColors.PROMOTION,
        [
          { name: "üéØ Soldado", value: `${target.tag}`, inline: true },
          { name: "üéñÔ∏è Nova Patente", value: `\`${newTagFull}\``, inline: true },
          { name: "üîπ Identifica√ß√£o", value: `\`${finalNickname}\``, inline: true },
          { name: "üéÆ Roblox", value: `\`${robloxUsername}\``, inline: true },
          { name: "‚ö° Executado por", value: `${interaction.user.tag}`, inline: true },
          { name: "‚úÖ Status", value: "`Verificado`", inline: true },
          { name: "üìÖ Data/Hora", value: `<t:${Math.floor(Date.now() / 1000)}:F>`, inline: false },
        ],
        target.displayAvatarURL()
      );

      // Canal de logs
      const logChannel = guild.channels.cache.find(
        (c) => c.name.toLowerCase() === "logs"
      );
      if (logChannel) {
        const logEmbed = createMilitaryEmbed(
          "ATUALIZA√á√ÉO DE PATENTE",
          `**Soldado:** ${target.tag}\n**Roblox:** ${robloxUsername}\n**Nova patente:** ${newTagFull}\n**Identifica√ß√£o:** ${finalNickname}\n**Executado por:** ${interaction.user.tag}`,
          embedColors.WARNING
        );
        logChannel.send({ embeds: [logEmbed] });
      }

      return interaction.editReply({ embeds: [successEmbed] });
    } catch (err) {
      console.error("Erro ao atualizar:", err);
      const errorEmbed = createMilitaryEmbed(
        "ERRO NA ATUALIZA√á√ÉO",
        "‚ùå **Falha ao atualizar o soldado.**\n\nVerifique as permiss√µes e tente novamente.",
        embedColors.ERROR
      );
      return interaction.editReply({ embeds: [errorEmbed] });
    }
  }

  // ========================================================
  // /patentes
  // ========================================================
  if (commandName === "patentes") {
    const patentesEmbed = createMilitaryEmbed(
      "üìä LISTA DE PATENTES MILITARES",
      "**Hierarquia completa das for√ßas armadas:**\n\nCada patente representa um degrau na carreira militar."
    );

    // Adicionar grupos de patentes
    Object.entries(rankGroups).forEach(([group, tags]) => {
      const patentesList = tags.map(tag => {
        const patenteInfo = Object.entries(patents).find(([key, value]) => value.startsWith(tag));
        return patenteInfo ? `‚Ä¢ ${patenteInfo[1]}` : `‚Ä¢ ${tag}`;
      }).join('\n');

      patentesEmbed.addFields({
        name: `üîπ ${group}`,
        value: patentesList,
        inline: true
      });
    });

    patentesEmbed.addFields({
      name: "üìù INSTRU√á√ïES",
      value: "‚Ä¢ Use `/conectar <c√≥digo>` para verificar sua conta\n‚Ä¢ Use `/manual` para ajuda detalhada\n‚Ä¢ **Pr√©-requisito:** Cargo 'Membro Verificado'",
      inline: false
    });

    await interaction.reply({ embeds: [patentesEmbed], ephemeral: true });
  }

  // ========================================================
  // /manual
  // ========================================================
  if (commandName === "manual") {
    const manualEmbed = createMilitaryEmbed(
      "üìö MANUAL DE INSTRU√á√ïES",
      "**Guia completo para verifica√ß√£o de conta militar**\n\nSiga os passos abaixo para se integrar √†s for√ßas armadas:"
    );

    manualEmbed.addFields(
      {
        name: "üéÆ PASSO 1: Obter C√≥digo no Roblox",
        value: "‚Ä¢ Entre no jogo Roblox\n‚Ä¢ V√° at√© o **Quartel General**\n‚Ä¢ Use o comando `/gerarcodigo`\n‚Ä¢ Anote o c√≥digo de 6 d√≠gitos",
        inline: false
      },
      {
        name: "üíª PASSO 2: Verificar no Discord",
        value: "‚Ä¢ Use o comando `/conectar <c√≥digo>`\n‚Ä¢ Substitua `<c√≥digo>` pelo c√≥digo obtido\n‚Ä¢ Aguarde a verifica√ß√£o autom√°tica",
        inline: false
      },
      {
        name: "‚úÖ PASSO 3: Confirma√ß√£o",
        value: "‚Ä¢ Seu nickname ser√° atualizado\n‚Ä¢ Voc√™ receber√° o cargo **Membro Verificado**\n‚Ä¢ Patente militar atribu√≠da automaticamente\n‚Ä¢ **Username do Roblox salvo para promo√ß√µes futuras**\n‚Ä¢ Verifica√ß√£o conclu√≠da com sucesso!",
        inline: false
      },
      {
        name: "üéñÔ∏è PROMO√á√ïES FUTURAS",
        value: "‚Ä¢ Use `/atualizar` (apenas administradores)\n‚Ä¢ Pr√©-requisito: Cargo 'Membro Verificado'\n‚Ä¢ **Usar√° o username do Roblox salvo**\n‚Ä¢ Hierarquia completa dispon√≠vel em `/patentes`",
        inline: false
      },
      {
        name: "üö® SUPORTE",
        value: "‚Ä¢ Problemas? Contate um **Oficial**\n‚Ä¢ C√≥digo n√£o funciona? Gere outro\n‚Ä¢ Erro persistente? Reporte ao comando",
        inline: false
      }
    );

    const row = new ActionRowBuilder()
      .addComponents(
        new ButtonBuilder()
          .setLabel('üéÆ Jogar Roblox')
          .setStyle(ButtonStyle.Link)
          .setURL('https://www.roblox.com/games/4753194980/NOVO-EB-Ex-rcito-Brasileiro'),
      );

    await interaction.reply({ 
      embeds: [manualEmbed], 
      components: [row],
      ephemeral: true 
    });
  }
});

// ============================================================
// üîë Login
// ============================================================
// ============================================================
// üöÄ CONFIGURA√á√ïES PARA DEPLOY 24/7 NO RENDER
// ============================================================

import http from 'http';

// Health check server para o Render
const server = http.createServer((req, res) => {
  if (req.url === '/health' && req.method === 'GET') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ 
      status: 'OK', 
      bot: discordBot.user?.tag || 'Starting...',
      uptime: process.uptime(),
      timestamp: new Date().toISOString()
    }));
  } else {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ 
      message: 'Military Bot API',
      endpoints: {
        health: 'GET /health'
      }
    }));
  }
});

const PORT = process.env.PORT || 3000;

server.listen(PORT, () => {
  console.log(`üü¢ Health check server running on port ${PORT}`);
});

// Tratamento de erros para evitar crashes
process.on('unhandledRejection', (error) => {
  console.error('‚ùå Unhandled Promise Rejection:', error);
});

process.on('uncaughtException', (error) => {
  console.error('‚ùå Uncaught Exception:', error);
});

// Graceful shutdown - importante para o Render
process.on('SIGTERM', () => {
  console.log('üîÑ Received SIGTERM, shutting down gracefully...');
  
  if (discordBot && discordBot.destroy) {
    discordBot.destroy();
    console.log('‚úÖ Bot Discord destroyed');
  }
  
  server.close(() => {
    console.log('‚úÖ HTTP server closed');
    process.exit(0);
  });
});

// ============================================================
// üåê Keep-Alive Ping ‚Äî evita que o Render desligue o servidor
// ============================================================
const express = require("express");
const app = express();

app.get("/ping", (req, res) => {
  res.status(200).send("pong");
});

app.listen(PORT, () => {
  console.log(`üíì KeepAlive ativo na porta ${PORT}`);
});

// ============================================================
// üîë LOGIN DO BOT (SEU C√ìDIGO ORIGINAL - MANTENHA)
// ============================================================
console.log('üöÄ Starting Military Bot...');

discordBot.login(process.env.DISCORD_TOKEN)
  .then(() => {
    console.log(`‚úÖ Bot successfully logged in as ${discordBot.user.tag}`);
    console.log('üéØ Bot is now online 24/7!');
  })
  .catch((error) => {
    console.error('‚ùå Failed to login:', error);
    process.exit(1);
  });
